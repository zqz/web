<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit File - zqz.ca</title>
</head>
<body>
    <header>
        <h1>zqz.ca - File Hosting</h1>
        <nav>
            <a href="/">Upload</a> |
            <a href="/files">Files</a> |
            <span id="navUsersWrap" style="display: none;"><a href="/users">Users</a> | </span>
            <a href="/api-docs">API Docs</a>
            <span id="authStatus">Loading...</span>
        </nav>
    </header>

    <hr>

    <div id="loadingState">
        <p>Loading file...</p>
    </div>

    <div id="errorState" style="display: none;">
        <h2>Error</h2>
        <p id="errorMessage"></p>
        <p><a href="/files">Back to Files</a></p>
    </div>

    <div id="fileContent" style="display: none;">
        <h2>Edit File</h2>

        <form id="editForm" onsubmit="saveFile(event)">
            <p>
                <label for="fileName">File Name:</label><br>
                <input type="text" id="fileName" name="name" required style="width: 400px;">
            </p>

            <p>
                <label for="fileComment">Description/Comment:</label><br>
                <textarea id="fileComment" name="comment" rows="4" style="width: 400px;"></textarea>
            </p>

            <p>
                <label>
                    <input type="checkbox" id="filePrivate" name="private">
                    Private (only you can access)
                </label>
            </p>

            <hr>

            <h3>File Information</h3>
            <ul>
                <li><strong>Slug:</strong> <span id="fileSlug"></span></li>
                <li><strong>Size:</strong> <span id="fileSize"></span></li>
                <li><strong>Type:</strong> <span id="fileType"></span></li>
                <li><strong>Hash:</strong> <code id="fileHash"></code></li>
                <li><strong>Uploaded:</strong> <span id="fileCreated"></span></li>
                <li><strong>Last Updated:</strong> <span id="fileUpdated"></span></li>
                <li><strong>Upload Status:</strong> <span id="fileStatus"></span></li>
            </ul>

            <h3>Download URL</h3>
            <p><code id="downloadURL"></code></p>
            <p><button type="button" id="downloadLink">Download File</button></p>

            <div id="imagePreview" style="display: none;">
                <h3>Preview</h3>
                <img id="previewImage" style="max-width: 100%; max-height: 400px;">
            </div>

            <hr>

            <p>
                <button type="submit" id="saveButton">Save Changes</button>
                <button type="button" onclick="globalThis.location.href='/files'">Cancel</button>
                <button type="button" onclick="deleteFile()" style="float: right; background: #dc2626; color: white;">Delete File</button>
            </p>

            <div id="saveStatus" style="display: none; margin-top: 10px; padding: 10px; background: #f0f0f0;"></div>
        </form>
    </div>

    <script>
        let currentUser = null;
        let currentFile = null;
        const slug = globalThis.location.pathname.split('/').pop();

        async function loadFile() {
            try {
                const response = await fetch(`/api/v1/file-metadata/${slug}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showError('File not found');
                    } else {
                        showError('Failed to load file');
                    }
                    return;
                }

                currentFile = await response.json();
                displayFile();

            } catch (error) {
                showError('Error loading file: ' + error.message);
            }
        }

        function displayFile() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('fileContent').style.display = 'block';

            // Populate form
            document.getElementById('fileName').value = currentFile.name;
            document.getElementById('fileComment').value = currentFile.comment || '';
            document.getElementById('filePrivate').checked = currentFile.private;

            // Populate info
            document.getElementById('fileSlug').textContent = currentFile.slug;
            document.getElementById('fileSize').textContent = formatBytes(currentFile.size);
            document.getElementById('fileType').textContent = currentFile.content_type;
            document.getElementById('fileHash').textContent = currentFile.hash;
            document.getElementById('fileCreated').textContent = new Date(currentFile.created_at).toLocaleString();
            document.getElementById('fileUpdated').textContent = new Date(currentFile.updated_at).toLocaleString();
            
            const isComplete = currentFile.bytes_received === currentFile.size;
            document.getElementById('fileStatus').textContent = isComplete ? '✓ Complete' : `Uploading (${currentFile.bytes_received}/${currentFile.size} bytes)`;

            // Download link
            const downloadUrl = `${globalThis.location.origin}/api/v1/files/${currentFile.slug}`;
            document.getElementById('downloadURL').textContent = downloadUrl;
            document.getElementById('downloadLink').onclick = function() { globalThis.open(downloadUrl, '_blank'); };

            // Image preview
            if (currentFile.content_type.startsWith('image/') && isComplete) {
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('previewImage').src = downloadUrl;
            }

            // Check if user can edit
            if (!currentUser || (currentFile.user_id && currentFile.user_id !== currentUser.id && !currentUser.admin)) {
                document.getElementById('saveButton').disabled = true;
                document.getElementById('saveButton').textContent = 'Save Changes (requires authentication)';
                document.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
            }
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        async function saveFile(event) {
            event.preventDefault();

            const saveStatus = document.getElementById('saveStatus');
            const saveButton = document.getElementById('saveButton');
            
            saveButton.disabled = true;
            saveStatus.style.display = 'block';
            saveStatus.style.background = '#f0f0f0';
            saveStatus.textContent = 'Saving...';

            const formData = {
                name: document.getElementById('fileName').value,
                comment: document.getElementById('fileComment').value,
                private: document.getElementById('filePrivate').checked
            };

            try {
                const response = await fetch(`/api/v1/files/${slug}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save changes');
                }

                currentFile = await response.json();
                
                saveStatus.style.background = '#d4edda';
                saveStatus.textContent = '✓ Changes saved successfully!';
                
                // Update displayed info
                document.getElementById('fileUpdated').textContent = new Date(currentFile.updated_at).toLocaleString();
                
                setTimeout(() => {
                    saveStatus.style.display = 'none';
                }, 3000);

            } catch (error) {
                saveStatus.style.background = '#f8d7da';
                saveStatus.textContent = '✗ Error: ' + error.message;
            } finally {
                saveButton.disabled = false;
            }
        }

        async function deleteFile() {
            if (!confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/files/${slug}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete file');
                }

                alert('File deleted successfully');
                globalThis.location.href = '/files';

            } catch (error) {
                alert('Error deleting file: ' + error.message);
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Authentication
        async function checkAuth() {
            try {
                const response = await fetch('/auth/me');
                const data = await response.json();
                
                currentUser = data.authenticated ? data : null;
                updateAuthUI();
            } catch (error) {
                console.error('Failed to check auth:', error);
                currentUser = null;
                updateAuthUI();
            }
        }

        function updateAuthUI() {
            const authStatus = document.getElementById('authStatus');
            const navUsersWrap = document.getElementById('navUsersWrap');
            if (navUsersWrap) navUsersWrap.style.display = (currentUser && currentUser.admin) ? 'inline' : 'none';
            if (currentUser) {
                authStatus.innerHTML = ` | Logged in as ${escapeHtml(currentUser.name)} - <a href="/auth/logout">Logout</a>`;
            } else {
                authStatus.innerHTML = ` | <a href="/auth/login">Login with Google</a>`;
            }
        }

        // Load on page load
        globalThis.addEventListener('load', async () => {
            await checkAuth();
            await loadFile();
        });
    </script>
</body>
</html>
