<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zqz.ca - File Hosting</title>
    <script src="/static/htmx.min.js"></script>
</head>
<body>
    <header>
        <h1>zqz.ca - File Hosting</h1>
        <nav>
            <a href="#" onclick="showSection('upload'); return false;">Upload</a> |
            <a href="#" onclick="showSection('files'); return false;">Files</a> |
            <a href="#" onclick="showSection('api'); return false;">API Docs</a>
            <span id="authStatus">Loading...</span>
        </nav>
    </header>

    <hr>

    <!-- Stats -->
    <div id="stats">
        <h2>Statistics</h2>
        <ul>
            <li>Total Files: <strong id="totalFiles">-</strong></li>
            <li>Total Size: <strong id="totalSize">-</strong></li>
            <li>Completed Uploads: <strong id="completedUploads">0</strong></li>
        </ul>
    </div>

    <hr>

    <!-- Upload Section -->
    <div id="uploadSection">
        <h2>Upload Files</h2>
        
        <div id="uploadArea" tabindex="0" role="button" onclick="document.getElementById('fileInput').click()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();document.getElementById('fileInput').click();}" style="border: 2px dashed #ccc; padding: 20px; cursor: pointer;">
            <p>Click here or drag files to upload</p>
            <p><small>Maximum file size: 100MB</small></p>
        </div>
        <input type="file" id="fileInput" multiple style="display: none;">

        <h3>Upload Queue</h3>
        <ul id="uploadQueue"></ul>
    </div>

    <!-- Files Section -->
    <div id="filesSection" style="display: none;">
        <h2>Your Files</h2>
        
        <p>
            <input type="text" id="searchInput" placeholder="Search files..." onkeyup="filterFiles()" style="width: 300px;">
        </p>

        <p>
            <strong>Filter:</strong>
            <a href="#" onclick="setFilter('all'); return false;">All Files</a> |
            <a href="#" onclick="setFilter('images'); return false;">Images</a> |
            <a href="#" onclick="setFilter('documents'); return false;">Documents</a> |
            <a href="#" onclick="setFilter('other'); return false;">Other</a>
        </p>

        <div id="fileListLoading">
            <p>Loading files...</p>
        </div>

        <ul id="fileList" style="display: none;"></ul>
        
        <div id="emptyState" style="display: none;">
            <p>No files uploaded yet. Upload your first file to get started!</p>
        </div>

        <p>
            <button id="loadMoreBtn" onclick="loadMoreFiles()" style="display: none;">Load More</button>
        </p>
    </div>

    <!-- API Docs Section -->
    <div id="apiSection" style="display: none;">
        <h2>API Documentation</h2>
        
        <h3>Base URL</h3>
        <p><code>http://localhost:3001/api/v1</code></p>

        <h3>Health Check</h3>
        <p><code>GET /health</code></p>

        <h3>Create File Metadata</h3>
        <pre>POST /api/v1/files
Content-Type: application/json

{
  "name": "example.txt",
  "hash": "sha1-hash-here",
  "size": 1024,
  "content_type": "text/plain",
  "private": false,
  "comment": "Optional comment"
}</pre>

        <h3>Upload File Data</h3>
        <pre>POST /api/v1/meta/{hash}
Content-Type: application/octet-stream

[binary file data]</pre>

        <h3>Download File</h3>
        <p><code>GET /api/v1/files/{slug}</code></p>

        <h3>List Files</h3>
        <p><code>GET /api/v1/files?limit=50&offset=0</code></p>
    </div>

    <!-- File Details Modal -->
    <div id="fileModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
        <div style="background: white; margin: 50px auto; padding: 20px; max-width: 600px;">
            <h2 id="modalFileName">File Details</h2>
            <button onclick="closeModal()" style="float: right;">Close</button>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        let allFiles = [];
        let filteredFiles = [];
        let currentFilter = 'all';
        let currentOffset = 0;
        const pageSize = 20;
        let uploadStats = {
            completed: 0
        };
        let currentUser = null;

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#f0f0f0';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.background = '';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = '';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
            }
        });

        async function calculateSHA1(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-1', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function handleFiles(files) {
            showSection('upload');
            
            for (let i = 0; i < files.length; i++) {
                await uploadFile(files[i]);
            }
        }

        async function uploadFile(file) {
            const uploadId = Date.now() + '-' + Math.random();
            const uploadItem = createUploadItem(uploadId, file.name);
            
            try {
                updateUploadStatus(uploadId, 'Calculating hash...');
                const hash = await calculateSHA1(file);

                updateUploadStatus(uploadId, 'Creating metadata...');
                const metaResponse = await fetch('/api/v1/files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: file.name,
                        hash: hash,
                        size: file.size,
                        content_type: file.type || 'application/octet-stream',
                        private: false,
                        comment: ''
                    })
                });

                if (!metaResponse.ok) {
                    throw new Error(`Failed to create file metadata: ${metaResponse.statusText}`);
                }

                const metadata = await metaResponse.json();

                updateUploadStatus(uploadId, 'Uploading data...');
                const uploadResponse = await fetch(`/api/v1/meta/${hash}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/octet-stream',
                    },
                    body: file
                });

                if (!uploadResponse.ok) {
                    throw new Error(`Failed to upload file: ${uploadResponse.statusText}`);
                }

                const result = await uploadResponse.json();
                const statusEl = document.getElementById('status-' + uploadId);
                if (statusEl) {
                    const downloadUrl = (result.download_url || '/api/v1/files/' + result.slug).replaceAll('"', '&quot;');
                    const viewUrl = (result.view_url || '').replaceAll('"', '&quot;');
                    const copySvg = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
                    statusEl.innerHTML = '✓ Uploaded · <a href="#file-' + escapeHtml(result.slug) + '">View in list</a> <button type="button" class="file-copy-link" title="Copy link" aria-label="Copy link" data-view-url="' + viewUrl + '" data-download-url="' + downloadUrl + '">' + copySvg + '</button>';
                }
                uploadStats.completed++;
                document.getElementById('completedUploads').textContent = uploadStats.completed;
                // Refresh file list then scroll to new file
                setTimeout(() => {
                    loadFiles();
                    setTimeout(() => {
                        const el = document.getElementById('file-' + result.slug);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 600);
                }, 500);

            } catch (error) {
                updateUploadStatus(uploadId, `✗ ${error.message}`);
            }
        }

        function createUploadItem(id, name) {
            const queue = document.getElementById('uploadQueue');
            const item = document.createElement('li');
            item.id = `upload-${id}`;
            item.innerHTML = `<strong>${escapeHtml(name)}</strong> - <span id="status-${id}">Preparing...</span>`;
            queue.insertBefore(item, queue.firstChild);
            return item;
        }

        function updateUploadStatus(id, message) {
            const statusEl = document.getElementById(`status-${id}`);
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        async function loadFiles(append = false) {
            const fileListLoading = document.getElementById('fileListLoading');
            const fileList = document.getElementById('fileList');
            const emptyState = document.getElementById('emptyState');

            if (!append) {
                currentOffset = 0;
                fileListLoading.style.display = 'block';
                fileList.style.display = 'none';
                emptyState.style.display = 'none';
            }

            try {
                const response = await fetch(`/api/v1/files?limit=${pageSize}&offset=${currentOffset}`);
                if (!response.ok) {
                    throw new Error('Failed to load files');
                }

                const files = await response.json();
                
                if (!append) {
                    allFiles = files;
                } else {
                    allFiles = allFiles.concat(files);
                }

                updateStats();
                applyFilter();
                
                fileListLoading.style.display = 'none';
                
                if (allFiles.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    fileList.style.display = 'block';
                    document.getElementById('loadMoreBtn').style.display = files.length === pageSize ? 'block' : 'none';
                }

            } catch (error) {
                fileListLoading.style.display = 'none';
                fileList.innerHTML = `<li>Failed to load files: ${error.message}</li>`;
                fileList.style.display = 'block';
            }
        }

        function loadMoreFiles() {
            currentOffset += pageSize;
            loadFiles(true);
        }

        function updateStats() {
            const totalSize = allFiles.reduce((sum, f) => sum + f.size, 0);
            document.getElementById('totalFiles').textContent = allFiles.length;
            document.getElementById('totalSize').textContent = formatBytes(totalSize);
        }

        function applyFilter() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredFiles = allFiles.filter(file => {
                const matchesSearch = file.name.toLowerCase().includes(searchTerm) || 
                                     file.comment.toLowerCase().includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || getFileCategory(file) === currentFilter;
                return matchesSearch && matchesFilter;
            });

            renderFiles();
        }

        function getFileCategory(file) {
            const type = file.content_type.toLowerCase();
            if (type.startsWith('image/')) return 'images';
            if (type.includes('pdf') || type.includes('document') || type.includes('text')) return 'documents';
            return 'other';
        }

        function renderFiles() {
            const fileList = document.getElementById('fileList');
            
            if (filteredFiles.length === 0 && currentFilter === 'all') {
                fileList.style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            fileList.innerHTML = filteredFiles.map(file => {
                const isComplete = file.bytes_received === file.size;
                return `
                    <li id="file-${file.slug}">
                        <strong>${escapeHtml(file.name)}</strong> 
                        (${formatBytes(file.size)}, ${file.content_type})
                        ${isComplete ? 
                            `- <a href="/api/v1/files/${file.slug}" download>Download</a> | <a href="#" onclick="showFileDetails('${file.slug}'); return false;">Details</a>` :
                            '- <em>Uploading...</em>'
                        }
                    </li>
                `;
            }).join('');
            const hash = window.location.hash;
            if (hash && hash.startsWith('#file-')) {
                const el = document.getElementById(hash.slice(1));
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function showFileDetails(slug) {
            const file = allFiles.find(f => f.slug === slug);
            if (!file) return;

            const isImage = file.content_type.startsWith('image/');
            const isComplete = file.bytes_received === file.size;

            document.getElementById('modalFileName').textContent = file.name;
            document.getElementById('modalBody').innerHTML = `
                ${isImage && isComplete ? `
                    <p><img src="/api/v1/files/${file.slug}" style="max-width: 100%;"></p>
                ` : ''}
                
                <ul>
                    <li><strong>File Name:</strong> ${escapeHtml(file.name)}</li>
                    <li><strong>Size:</strong> ${formatBytes(file.size)}</li>
                    <li><strong>Type:</strong> ${file.content_type}</li>
                    <li><strong>Uploaded:</strong> ${new Date(file.created_at).toLocaleString()}</li>
                    ${file.comment ? `<li><strong>Comment:</strong> ${escapeHtml(file.comment)}</li>` : ''}
                    <li><strong>Download URL:</strong><br><code>${window.location.origin}/api/v1/files/${file.slug}</code></li>
                </ul>
                ${isComplete ? `
                    <p><a href="/api/v1/files/${file.slug}" download>Download File</a></p>
                ` : `
                    <p><em>File is still uploading...</em></p>
                `}
            `;

            document.getElementById('fileModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('fileModal').style.display = 'none';
        }

        function setFilter(filter) {
            currentFilter = filter;
            applyFilter();
        }

        function filterFiles() {
            applyFilter();
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSection(section) {
            document.getElementById('uploadSection').style.display = section === 'upload' ? 'block' : 'none';
            document.getElementById('filesSection').style.display = section === 'files' ? 'block' : 'none';
            document.getElementById('apiSection').style.display = section === 'api' ? 'block' : 'none';
            
            if (section === 'files') {
                loadFiles();
            }
        }

        // Authentication
        async function checkAuth() {
            try {
                const response = await fetch('/auth/me');
                const data = await response.json();
                
                currentUser = data.authenticated ? data : null;
                updateAuthUI();
            } catch (error) {
                console.error('Failed to check auth:', error);
                currentUser = null;
                updateAuthUI();
            }
        }

        function updateAuthUI() {
            const authStatus = document.getElementById('authStatus');
            
            if (currentUser) {
                authStatus.innerHTML = ` | Logged in as ${escapeHtml(currentUser.name)} - <a href="/auth/logout">Logout</a>`;
            } else {
                authStatus.innerHTML = ` | <a href="/auth/login">Login with Google</a>`;
            }
        }

        // Close modal on background click
        document.getElementById('fileModal').addEventListener('click', (e) => {
            if (e.target.id === 'fileModal') {
                closeModal();
            }
        });

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.file-copy-link');
            if (!btn) return;
            const viewUrl = btn.dataset.viewUrl || '';
            const downloadUrl = btn.dataset.downloadUrl || '';
            const path = (viewUrl && viewUrl.trim() !== '') ? viewUrl : downloadUrl;
            if (!path) return;
            const url = window.location.origin + path;
            navigator.clipboard.writeText(url).then(() => {
                btn.classList.add('copied');
                btn.setAttribute('title', 'Copied!');
                setTimeout(() => { btn.classList.remove('copied'); btn.setAttribute('title', 'Copy link'); }, 1500);
            });
        });

        // Load on page load
        window.addEventListener('load', () => {
            checkAuth();
            loadFiles();
        });
    </script>
    <style>.file-copy-link{margin-left:.35rem;padding:0;border:none;background:none;cursor:pointer;color:#666;vertical-align:middle}.file-copy-link:hover{color:#111}.file-copy-link.copied{color:#15803d}</style>
</body>
</html>
